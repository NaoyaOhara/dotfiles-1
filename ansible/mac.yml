---
- hosts: default
  gather_facts: no
  sudo: no
  vars:
    homebrew_packages_taps:
      - caskroom/cask
      - caskroom/versions
      - homebrew/binary
      - peco/peco
      - sanemat/font

    homebrew_packages_packages:
      - { name: brew-cask }
      - { name: coreutils }
      - { name: dtach }
      - { name: git }
      - { name: git-flow }
      - { name: htop-osx }
      - { name: jq }
      - { name: lftp }
      - { name: lua }
      - { name: lv }
      - { name: mosh }
      - { name: node }
      - { name: peco }
      - { name: perl-build }
      - { name: plenv }
      - { name: pt }
      - { name: pyenv }
      - { name: rbenv }
      - { name: reattach-to-user-namespace }
      - { name: ruby-build }
      - { name: ssh-copy-id }
      - { name: terminal-notifier }
      - { name: tig }
      - { name: tmux }
      - { name: vimpager }
      - { name: zpython }

    homebrew_cask_packages_packages:
      - 1password
      - air-video-server-hd
      - contexts
      - cyberduck
      - dash
      - dropbox
      - firefox
      - flash-player
      - flux
      - freemind
      - google-chrome
      - ibettercharge
      - iterm2
      - karabiner
      - keycastr
      - lastfm
      - limechat
      - macvim
      - mailbox
      - vagrant
      - virtualbox
      - vmware-fusion
      - vlc
      - xquartz

  pre_tasks:
    - name: touch .bashrc
      file: path=~/.bashrc state=touch
    - name: touch .bash_profile
      file: path=~/.bash_profile state=touch

  roles:
    - role: dghubble.homebrew-role
      bash_shell: True
    - hnakamur.homebrew-packages
    - hnakamur.homebrew-cask-packages

  tasks:
    # install phase
    - name:        install ricty # ricty needs xquartz that cask installs
      homebrew:    name=ricty install_options=patch-in-place,powerline,vim-powerline
      environment: { PATH: '/usr/local/bin:/usr/bin:/bin' }
    - name:     ricty version
      shell:    brew info ricty | head -1 | perl -pe 's/.*stable (\d+(?:\.\d+)*).*/\1/s'
      register: ricty_version
      environment: { PATH: '/usr/local/bin:/usr/bin:/bin' }
    - name: copy ricty
      command: cp -f {{ item }}.ttf ~/Library/Fonts/
      args:
        chdir:   /usr/local/Cellar/ricty/{{ ricty_version.stdout }}/share/fonts
        creates: ~/Library/Fonts/{{ item }}.ttf
      with_items:
        - Ricty-Bold
        - Ricty-Regular
        - RictyDiscord-Bold
        - RictyDiscord-Regular
    - name: fc-cache -f
      command: fc-cache -f
      environment: { PATH: '/usr/X11/bin:/usr/local/bin:/usr/bin:/bin' }
    - name: install Firefox Developer edition
      command: brew cask install firefoxdeveloperedition-ja
      environment: { PATH: '/usr/local/bin:/usr/bin:/bin' }
    - name:        install jshint
      command:     npm install -g jshint
      environment: { PATH: '/usr/local/bin:/usr/bin:/bin' }
    - name:         install pip
      easy_install: name=pip
    - name: install powerline
      command: pip install --user git+https://github.com/powerline/powerline

    # dotfiles phase
    - name: mkdir git
      file: path=~/git state=directory
    - name: clone dotfiles
      git:  repo=https://github.com/delphinus35/dotfiles dest=~/git/dotfiles
    - name:    update submodules
      command: git submodule update --init chdir=~/git/dotfiles
    - name:       set symlinks
      file:       src=~/git/dotfiles/{{ item }} dest=~/{{ item }} state=link force=yes
      with_items:
        - .config/ipython
        - .config/peco
        - .config/powerline
        - .editrc
        - .gitconfig
        - .inputrc
        - .vim
        - .zshrc
    - name: set Karabiner setting file
      copy: src=../Karabiner/private.xml dest=~/Library/Application\ Support/Karabiner/private.xml

    # htop setting
    - name: set owner / permission to htop
      file: owner=root group=wheel mode=u+s follow=yes path=/usr/local/bin/htop
      sudo: yes

    # other
    - name:        set symlinks for macvim
      file:        src=mvim dest=/usr/local/bin/{{ item }} state=link
      environment: { PATH: '/usr/local/bin:/usr/bin:/bin' }
      with_items:
        - vim
        - vimdiff
        - view
        - gvim
        - gvimdiff
        - gview
        - mvimdiff
        - mview
